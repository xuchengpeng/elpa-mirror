Ported from the original by github.com/ahmadawais
